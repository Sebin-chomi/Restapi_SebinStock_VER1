# 문지기봇 설계 검토 결과

## 🔍 현재 구현 vs 설계 비교

### ❌ 입구 필터 (Gate Filter) - 불일치

**설계 요구사항:**
- 거래량 = 0 제외
- 거래대금 < 25억 원 제외
- 관리종목/거래정지/상장폐지 예정 제외
- 필수 데이터 결손 제외

**현재 구현:**
```python
# selector.py 199-206줄
if cfg.phase == "normal":
    universe = latest[
        (latest["close"] >= cfg.min_price) &  # 500원
        (latest["turnover_krw"] >= cfg.min_turnover_krw) &  # 20억 (설계: 25억)
        (latest["vol_avg"] >= cfg.min_avg_vol_20)  # 50,000
    ]
else:
    universe = latest[latest["close"] >= cfg.min_price]
```

**문제점:**
1. ❌ 거래량 = 0 체크 없음
2. ❌ 거래대금 기준 20억 (설계: 25억)
3. ❌ 관리종목/거래정지/상장폐지 체크 없음
4. ❌ 필수 데이터 결손 체크 없음
5. ❌ warmup 모드에서 필터링이 너무 약함

---

### ❌ 1차 필터 (Primary Filter) - 불일치

**설계 요구사항:**
- OR 조건: 거래량 스파이크 >= 1.8 OR 거래대금 >= 50억 OR 일중 변동성 >= 3.0%
- 출력 규모: 최소 30종목, 권장 80종목, 최대 120종목
- 120 초과 시 거래대금/거래량 스파이크 기준 점진적 상향

**현재 구현:**
- 1차 필터가 없음
- 바로 버킷별 점수 계산 후 상위 종목 선정
- 출력 규모 관리 로직 없음

**문제점:**
1. ❌ 1차 필터 단계가 없음
2. ❌ OR 조건 필터링 없음
3. ❌ 출력 규모 관리 없음 (현재는 고정 할당량: largecap 2 + volume 2 + structure 2 + theme 2 = 8종목)

---

### ⚠️ 일중 변동성 계산 방식 차이

**설계:**
- 일중 변동성 = (고가 - 저가) ÷ 시가
- 기준: >= 3.0%

**현재 구현:**
```python
# selector.py 101줄
df["hlc_volatility"] = (df["high"] - df["low"]) / df["close"].replace(0, pd.NA)
```
- 일중 변동성 = (고가 - 저가) ÷ 종가
- 기준: >= 3.0% (0.03)

**차이점:** 시가 vs 종가 사용

---

## 📋 수정 필요 사항

### 1. 입구 필터 구현
- [ ] 거래량 = 0 체크 추가
- [ ] 거래대금 기준 25억으로 변경
- [ ] 관리종목/거래정지/상장폐지 체크 추가 (데이터 소스 필요)
- [ ] 필수 데이터 결손 체크 추가
- [ ] warmup 모드에서도 최소한의 필터 적용

### 2. 1차 필터 구현
- [ ] 1차 필터 단계 추가 (입구 필터 통과 후)
- [ ] OR 조건 필터링 구현:
  - 거래량 스파이크 >= 1.8
  - 거래대금 >= 50억
  - 일중 변동성 >= 3.0%
- [ ] 출력 규모 관리 로직 추가:
  - 최소 30종목
  - 권장 80종목
  - 최대 120종목
  - 120 초과 시 기준 점진적 상향

### 3. 일중 변동성 계산 수정
- [ ] 시가 기준으로 변경: (고가 - 저가) ÷ 시가

### 4. 2차 필터 (현재 구현)
- 현재 버킷별 점수 계산 및 상위 종목 선정은 유지
- 다만 1차 필터 통과 종목에 대해서만 수행

---

## 🔄 수정 후 흐름

```
전 종목 입력
  ↓
[입구 필터]
  - 거래량 = 0 제외
  - 거래대금 < 25억 제외
  - 관리종목/거래정지/상장폐지 제외
  - 필수 데이터 결손 제외
  ↓
[1차 필터] (OR 조건)
  - 거래량 스파이크 >= 1.8 OR
  - 거래대금 >= 50억 OR
  - 일중 변동성 >= 3.0%
  ↓
출력 규모 관리
  - 최소 30종목 보장
  - 권장 80종목
  - 최대 120종목 (초과 시 기준 상향)
  ↓
[2차 필터] (현재 구현 유지)
  - 버킷별 점수 계산
  - 상위 종목 선정
  ↓
최종 후보군 출력 (5~6종목)
```







