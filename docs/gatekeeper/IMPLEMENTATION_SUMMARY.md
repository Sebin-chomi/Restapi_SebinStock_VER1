# 문지기봇 설계 구현 완료 요약

## ✅ 구현 완료 사항

### 1. 입구 필터 (Gate Filter)
- ✅ 거래량 = 0 제외
- ✅ 거래대금 < 25억 원 제외
- ✅ 최소 가격 필터 (500원)
- ✅ 필수 데이터 결손 체크 (NaN 제거)
- ⚠️ 관리종목/거래정지/상장폐지 체크는 별도 데이터 소스 필요 (현재는 OHLCV만으로 판단 불가)

### 2. 1차 필터 (Primary Filter)
- ✅ OR 조건 구현:
  - 거래량 스파이크 >= 1.8
  - 거래대금 >= 50억
  - 일중 변동성 >= 3.0% (시가 기준)
- ✅ 출력 규모 관리:
  - 최소 30종목 보장 (기준 완화)
  - 권장 80종목
  - 최대 120종목 (기준 상향 또는 상위 120개 선택)

### 3. 일중 변동성 계산
- ✅ 시가 기준으로 변경: (고가 - 저가) ÷ 시가
- ✅ 기존 호환성 유지: `hlc_volatility` (종가 기준)도 유지

### 4. Config 업데이트
- ✅ 입구 필터 파라미터 추가
- ✅ 1차 필터 파라미터 추가
- ✅ 출력 규모 관리 파라미터 추가

## 📋 주요 변경 파일

### `scout_selector/selector.py`
1. **Config 클래스 확장**
   - `gate_filter_min_turnover_krw`: 25억
   - `primary_filter_vol_spike_min`: 1.8
   - `primary_filter_min_turnover_krw`: 50억
   - `primary_filter_min_volatility`: 0.03 (3.0%)
   - `primary_filter_output_min/target/max`: 30/80/120

2. **새로운 함수 추가**
   - `apply_gate_filter()`: 입구 필터 적용
   - `apply_primary_filter()`: 1차 필터 적용 (OR 조건)
   - `manage_primary_filter_output_size()`: 출력 규모 관리

3. **기존 함수 수정**
   - `compute_features()`: 일중 변동성 계산 추가 (시가 기준)
   - `score_volume()`: 일중 변동성 사용
   - `select_watchlist()`: 필터링 단계 추가

## 🔄 처리 흐름

```
전 종목 입력
  ↓
[입구 필터]
  - 거래량 = 0 제외
  - 거래대금 < 25억 제외
  - 최소 가격 >= 500원
  - 필수 데이터 결손 제외
  ↓
[1차 필터] (OR 조건)
  - 거래량 스파이크 >= 1.8 OR
  - 거래대금 >= 50억 OR
  - 일중 변동성 >= 3.0%
  ↓
[출력 규모 관리]
  - 최소 30종목 보장 (기준 완화)
  - 최대 120종목 (기준 상향 또는 상위 선택)
  ↓
[2차 필터] (버킷별 점수 계산)
  - 거래량형 점수 계산
  - 구조형 점수 계산
  - 테마형 점수 계산
  ↓
[최종 선정]
  - 각 버킷별 할당량에 맞춰 상위 종목 선정
  - largecap 2 + volume 2 + structure 2 + theme 2 = 8종목
  ↓
최종 후보군 출력
```

## ⚠️ 주의사항

1. **관리종목/거래정지/상장폐지 체크**
   - 현재는 OHLCV 데이터만으로는 판단 불가
   - 별도 데이터 소스 필요 시 `apply_gate_filter()` 함수에 추가 필요

2. **출력 규모 관리**
   - 최소 30종목 미만 시 기준을 최대 3회 완화 (10%씩)
   - 최대 120종목 초과 시 기준을 최대 3회 상향 (10%씩)
   - 여전히 초과하면 거래대금 기준 상위 120개 선택

3. **일중 변동성 계산**
   - 시가 기준: `intraday_volatility` (새로 추가)
   - 종가 기준: `hlc_volatility` (기존 호환성 유지)

## 🧪 테스트 필요 사항

1. 입구 필터 동작 확인
2. 1차 필터 OR 조건 동작 확인
3. 출력 규모 관리 로직 확인 (30/80/120 종목)
4. 일중 변동성 계산 정확성 확인 (시가 기준)
5. 기존 기능 호환성 확인 (2차 필터, 버킷별 선정)



