# 2차 필터 (Secondary Filter) 구현 완료

## ✅ 구현 완료 사항

### 1. 구조형 점수 체계 (0 ~ 100점)

**점수 구성:**
- 이동평균 구조: 35점
  - 단/중/장기 MA 정배열: +20점
  - MA 기울기 상승 전환: +10점
  - MA 밀집 후 확산: +5점

- 그랜빌 법칙: 25점
  - MA 상향 돌파: +15점
  - 눌림 후 MA 지지 확인: +10점
  - MA 이탈 경고: -5점
  - MA 과도 이격: -5점

- 고점·저점 구조: 25점
  - Higher Low 형성: +10점
  - 최근 N일 고점 갱신: +10점
  - 박스 상단 돌파 유지: +5점

- 안정성 보정: 15점
  - 변동성 과다 아님: +5점
  - 장대 음봉 직후 아님: +5점
  - 단기 과열 상태 아님: +5점

**특징:**
- 점수 단독 탈락 절대 금지 (우선순위 결정용)
- 점수 범위: 0 ~ 100점

### 2. 구조형 후보 유지 기준

- 구조 점수 60점 이상 우선 선택
- 구조형 후보군: Top 8 ~ 12종목
- 60점 미만이지만 상위 종목도 최소 8종목 보장

### 3. 최종 후보군 압축

**목표:**
- 최종 정찰 대상 수: 5 ~ 6종목

**권장 구성:**
- 거래량형: 2종목
- 구조형: 2종목
- 테마형: 1 ~ 2종목

**보정 원칙:**
- 단일 카테고리 3종목 초과 금지
- 특정 카테고리 부족 시 타 카테고리에서 보충
- 최소 5종목 보장, 최대 6종목 제한

### 4. 추가된 Feature

**이동평균 관련:**
- `ma5`, `ma20`, `ma60`: 단/중/장기 이동평균
- `ma5_slope`, `ma20_slope`: MA 기울기 (전일 대비 변화율)
- `ma_spread`: MA 밀집도 (MA 간 거리)

**고점/저점 구조:**
- `higher_low`: Higher Low 형성 여부
- `new_high`: 최근 20일 고점 갱신 여부

**안정성 체크:**
- `big_red_candle`: 장대 음봉 체크 (전일 대비 하락률 > 5%)
- `short_term_overheat`: 단기 과열 체크 (최근 5일 상승률 > 15%)

## 📋 주요 변경 파일

### `scout_selector/selector.py`

1. **`compute_features()` 함수 확장**
   - 이동평균 계산 (ma5, ma20, ma60)
   - MA 기울기 계산
   - MA 밀집도 계산
   - 고점/저점 구조 체크
   - 안정성 체크

2. **`score_structure()` 함수 재구현**
   - 0~100점 점수 체계로 변경
   - 4가지 구성 요소별 점수 계산
   - 점수 단독 탈락 금지 (항상 양수 반환)

3. **`_pick_structure()` 함수 개선**
   - 60점 이상 우선 선택
   - Top 8~12 후보군 유지
   - 상세 reason 정보 포함

4. **`_compress_final_candidates()` 함수 추가**
   - 최종 후보군 압축 로직
   - 권장 구성 유지
   - 부족 시 보충, 초과 시 압축

5. **`SelectionQuota` 클래스 확장**
   - 구조형 후보 유지 기준 파라미터
   - 최종 후보군 압축 파라미터

## 🔄 처리 흐름

```
[1차 필터 통과 종목] (30~120종목)
  ↓
[2차 필터: 버킷별 점수 계산]
  - 거래량형 점수 계산
  - 구조형 점수 계산 (0~100점)
  - 테마형 점수 계산
  ↓
[구조형 후보 유지]
  - 60점 이상 우선 선택
  - Top 8~12 후보군 확보
  ↓
[최종 후보군 압축]
  - 거래량형: 2종목
  - 구조형: 2종목
  - 테마형: 1~2종목
  - 단일 카테고리 3종목 초과 금지
  - 부족 시 보충, 초과 시 압축
  ↓
최종 후보군 출력 (5~6종목)
```

## ⚠️ 주의사항

1. **구조형 점수 계산**
   - 그랜빌 법칙의 마이너스 점수는 최종 점수에서 차감되지만, 0점 이하로 내려가지 않음
   - 점수 단독 탈락 금지 원칙 준수

2. **최종 후보군 압축**
   - 대형주는 항상 포함 (largecap)
   - 각 카테고리별로 최대 3종목 제한
   - 총 5~6종목 유지

3. **Feature 계산**
   - 일부 feature는 과거 데이터가 부족할 수 있음
   - `min_periods=1`로 설정하여 데이터 부족 시에도 계산 가능

## 🧪 테스트 필요 사항

1. 구조형 점수 계산 정확성 확인 (0~100점 범위)
2. 구조형 후보 유지 기준 동작 확인 (60점 이상 우선, Top 8~12)
3. 최종 후보군 압축 로직 확인 (5~6종목, 권장 구성)
4. 단일 카테고리 3종목 초과 금지 확인
5. 부족 시 보충 로직 확인



